<?php

namespace App\Http\Controllers;

use Illuminate\Http\Request;
use App\Http\Controllers\Controller;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Auth;
use Illuminate\Support\Facades\Hash;
use Illuminate\Support\Facades\File;
use App\Http\Requests;
use App\Http\Helper;
use App\Models\Users;
use App\Models\ParkingSpot;
use App\Models\Pricing;
use App\Models\GeneralSettings;
use Mail;


class BookingController extends Controller {
    /*=============================Start Admin Function===============================*/
    
    /* Start - this function for redirect on booking list*/
    public function bookingListAdmin() {
        return view('booking/bookigList');
    }
    /* End - this function for redirect on booking list*/
    
    /* Start - this function for get booking list using datatable*/
    public function AjaxBookingList($order_by = "id", $sort_order = "asc", $search = "all", $offset = 0) {
        
        $Booking = new \App\Models\Booking();

        $aColumns = array('id','firstname','lastname','','contact_number',
                          'host_firstname','host_lastname','','host_contact_number',
            'address','postal_code','country_name','state_name','city_name',
            'generated_booking_id','booking_date','booking_time','booking_amount','booking_hours','booking_days','booking_month','booking_type','booking_status','status');
        $grid_data = Helper::get_search_data($aColumns);
        
        
        $sort_order = $grid_data['sort_order'];
        $order_by = $grid_data['order_by'];
        if ($grid_data['sort_order'] == '' && $grid_data['order_by'] == '') {
            $order_by = 'id';
            $sort_order = 'DESC';
        }

        /*
         * Paging
         */
        $limit = $grid_data['per_page'];
        $offset = $grid_data['offset'];


        $SearchType = $grid_data['SearchType'];
        $search_data = $grid_data['search_data'];
        
        $data = $this->trim_serach_data($search_data, $SearchType);
        
        $Booking->set_data($data);
        $Booking->set_SearchType($SearchType);
        $Booking->set_order_by($order_by);
        $Booking->set_sort_order($sort_order);
        $Booking->set_limit($limit);
        $Booking->set_offset($offset);
        $result = $Booking->get_data_for_booking();
        
        /*echo '<pre>';
        print_r($result);exit;*/
       
        $data = array();
        if (count($result) > 0) {
            $data['result'] = $result;
            $data['totalRecord'] = $Booking->count_all_booking_grid();
        }
        
        $output = array(
            "sEcho" => intval($_GET['sEcho']),
            "iTotalRecords" => 0,
            "iTotalDisplayRecords" => 0,
            "aaData" => array()
        );
        
        if (isset($data) && !empty($data)) {
            if (isset($data['result']) && !empty($data['result'])) {
                $output = array(
                    "sEcho" => intval($_GET['sEcho']),
                    "iTotalRecords" => $data['totalRecord'],
                    "iTotalDisplayRecords" => $data['totalRecord'],
                    "aaData" => array()
                );
                /*echo '<pre>';
                print_r($data['result']);exit;*/
                foreach ($data['result'] AS $result_row) {
                    $row = array();
                    $row[] = $result_row->id;
                    $row[] = $result_row->firstname;
                    $row[] = $result_row->lastname;
                    $row[] = !empty($result_row->profile_image) ? asset('uploads/user_profile_image/' . $result_row->profile_image) : '';
                    $row[] = $result_row->contact_number;
                    $row[] = $result_row->host_firstname;
                    $row[] = $result_row->host_lastname;
                    $row[] = !empty($result_row->host_profile_image) ? asset('uploads/user_profile_image/' . $result_row->host_profile_image) : '';
                    $row[] = $result_row->host_contact_number;
                    $row[] = $result_row->address;
                    $row[] = $result_row->postal_code;
                    $row[] = $result_row->country_name;
                    $row[] = $result_row->state_name;
                    $row[] = $result_row->city_name;
                    $row[] = $result_row->generated_booking_id;
                    $row[] = $result_row->booking_date;
                    $row[] = $result_row->booking_time;
                    $row[] = $result_row->booking_amount;
                    $row[] = $result_row->booking_hours;
                    $row[] = $result_row->booking_days;
                    $row[] = $result_row->booking_month;
                    $row[] = $result_row->booking_type;
                    $row[] = $result_row->booking_status;
                    $row[] = $result_row->status;
                    $row[] = $result_row->users_id;
                    //$row[] = array();
                    $output['aaData'][] = $row;
                }
                
            }
        }
        //print_r(json_encode($output));exit;
        echo json_encode($output);
    }
    /* End - this function for get booking list using datatable*/
    
    /* Start this is halping function for data table and & like query*/
    public function trim_serach_data($search_data, $SearchType) {
       $QueryStr = array();

        if (!empty($search_data)) {
            if ($SearchType == 'ANDLIKE') {
                $i = 0;
                foreach ($search_data as $key => $val) {
                    if ($key == 'firstname' && !empty($val)) {
                        $QueryStr[$i]['Field'] = 'users.firstname';
                        $QueryStr[$i]['Value'] = $val;
                        $QueryStr[$i]['Operator'] = 'LIKE';
                    }
                    if ($key == 'lastname' && !empty($val)) {
                        $QueryStr[$i]['Field'] = 'users.lastname';
                        $QueryStr[$i]['Value'] = $val;
                        $QueryStr[$i]['Operator'] = 'LIKE';
                    }
                    if ($key == 'host_firstname' && !empty($val)) {
                        $QueryStr[$i]['Field'] = 'host.firstname';
                        $QueryStr[$i]['Value'] = $val;
                        $QueryStr[$i]['Operator'] = 'LIKE';
                    }
                    if ($key == 'host_lastname' && !empty($val)) {
                        $QueryStr[$i]['Field'] = 'host.lastname';
                        $QueryStr[$i]['Value'] = $val;
                        $QueryStr[$i]['Operator'] = 'LIKE';
                    }
                    
                    if ($key == 'address' && !empty($val)) {
                        $QueryStr[$i]['Field'] = 'parking_spot.address';
                        $QueryStr[$i]['Value'] = $val;
                        $QueryStr[$i]['Operator'] = 'LIKE';
                    }
                    if ($key == 'country_name' && !empty($val)) {
                        $QueryStr[$i]['Field'] = 'country.country_name';
                        $QueryStr[$i]['Value'] = $val;
                        $QueryStr[$i]['Operator'] = 'LIKE';
                    }
                    if ($key == 'state_name' && !empty($val)) {
                        $QueryStr[$i]['Field'] = 'state.state_name';
                        $QueryStr[$i]['Value'] = $val;
                        $QueryStr[$i]['Operator'] = 'LIKE';
                    }
                    if ($key == 'city_name' && !empty($val)) {
                        $QueryStr[$i]['Field'] = 'parking_spot.city_name';
                        $QueryStr[$i]['Value'] = $val;
                        $QueryStr[$i]['Operator'] = 'LIKE';
                    }
                    if ($key == 'booking_type' && !empty($val)) {
                        $QueryStr[$i]['Field'] = 'booking.booking_type';
                        $QueryStr[$i]['Value'] = $val;
                        $QueryStr[$i]['Operator'] = '=';
                    }
                    if ($key == 'status' && !empty($val)) {
                        $QueryStr[$i]['Field'] = 'booking.status';
                        $QueryStr[$i]['Value'] = $val;
                        $QueryStr[$i]['Operator'] = '=';
                    }
                    $i++;
                }
            } 
        }
        return $QueryStr;
    }
    /* End this is halping function for data table and & like query*/
    
    /**
     * Remove the specified resource from storage.
     *
     * @param  int  $id
     * @return \Illuminate\Http\Response
     */
    public function deletebooking_admin(Request $request) {
        $Booking = new \App\Models\Booking();
        $id = $request->id;
        //Code to check if the id from the url exists in the table or not starts here. 
        //If id does not exists, redirect it to 404 page.
        $id_exists = Helper::check_id_exists($id, 'booking');
        if (!$id_exists) {
            return view('error.404');
        }
        //Code to check id ends here
        $del_user = $Booking->delete_record_of_booking_id_ids($id);

        if ($del_user) {
            echo '1';
        } else {
            echo '0';
        }
        exit;
    }
    /*Start - This function for view image of parking spot*/
    public function manageparkingspotGallery($generated_booking_id) {
        
        $Booking = new \App\Models\Booking();
        $parking_spot_images = $Booking->get_parking_spot_image($generated_booking_id);
        
        /*echo '<pre>';
        print_r($parking_spot_images);exit;*/
        return view('booking/manageparkingspotImage', ['parking_spot_images' => $parking_spot_images, 'parking_spot_id' => $parking_spot_images[0]->parking_spot_id]);
    }
    /*END - This function for view image of parking spot*/
    
    /*Start - This function for view review and rating page*/
    public function bookingReviewRating($booking_id,$user_id) {
        
        $Review = new \App\Models\Review();
        $review_reting_details = $Review->review_reting_details_by_renter_id_and_booking_id($booking_id,$user_id);
        
        if(isset($review_reting_details) && !empty($review_reting_details)){
            $questions_answer = json_decode($review_reting_details[0]->questions_answer);
            $temp_array = [];
            foreach($questions_answer as $loop){
                 foreach($loop as $key=>$single){
                        $get_all_questions = $Review->get_question_by_id($key);
                        if(isset($get_all_questions) && !empty($get_all_questions)){
                            $get_all_questions[0]->answer = $single;
                        }
                        array_push($temp_array,$get_all_questions);
                    }
            }
            $review_reting_details[0]->questions_answer = $temp_array;
            
            $review_reting_details_host = $Review->review_reting_details_by_booking_id_for_host($booking_id);
            $questions_answer = json_decode($review_reting_details_host[0]->questions_answer);
            $temp_array_host = [];
            foreach($questions_answer as $loops){
                 foreach($loops as $key=>$single){
                        $get_all_questions_host = $Review->get_question_by_id($key);
                        if(isset($get_all_questions_host) && !empty($get_all_questions_host)){
                            $get_all_questions_host[0]->answer = $single;
                        }
                        array_push($temp_array_host,$get_all_questions_host);
                    }
            }
            $review_reting_details_host[0]->questions_answer = $temp_array_host;
            /*echo '<pre>';
            print_r($review_reting_details_host); exit;*/
            
            return view('booking/bookingReviewRating',['review_reting_details' => $review_reting_details,'review_reting_details_host' => $review_reting_details_host]);
        }else {
            $message = 'Review and Rating details are not available in this booking.';
            return redirect('booking/managebooking')->with('message', $message);
        }
        
        
    }
    /*END - This function for view review and rating page*/
    
   
    /*=============================Start API Function===============================*/
    /*
     * Request Parameter :  [Apikey, userID, parking_spot_id, selected_date, selected_time, no_of_hours, no_of_days, no_of_month]
     * Method : POST
     * Request Api Url : "/api/addbooking"
     * Request Controller & Method : BookingController/addbooking
     * Success response : [ message : Parking Spot save SuccessFully.,  code : 200, data : Array of Parking Spot Details]
     * Error response : 
      1)[ message : Parking spot does not available., code : 101]
      2)[ message : Booking does not save SuccessFully., code : 101]
      3)[ message : Unauthorised Call. , code : 101]
     */

    public function addbooking(Request $request) {
        $userID = $request->userID;
        $parking_spot_id = $request->parking_spot_id;
        $selected_date = date('Y-m-d', strtotime($request->selected_date));
        $selected_time = date('H:i:s', strtotime($request->selected_time));
        $no_of_hours_req = $request->no_of_hours;
        $no_of_days_req = $request->no_of_days;
        $no_of_month_req = $request->no_of_month;

        $cancellation_fee = '';
        //---------------------- Start : Send admin pricing in array --------------//
        $pricing_array = array();
        $pricing_array = Pricing::select('id', 'no_of_hours', 'hourly_price', 'no_of_days', 'daily_price', 'no_of_month', 'monthly_price', 'monthly_price')->Where('status', 'Active')->first();
        $GeneralSettings = GeneralSettings::select('cancellation_fee', 'commission_amount')->first();
        //---------------------- End : Send admin pricing in array --------------//
        $paid_amount = '';
        $total_time = '';

        if (!empty($no_of_hours_req)) {
            $no_of_hours = $no_of_hours_req;
            $no_of_days = '';
            $no_of_month = '';
            $paid_amount = (count($pricing_array) > 0) ? $pricing_array->hourly_price : '0';
            $booking_type = "Hours";
            $total_time = $no_of_hours . ' Hours';
        } else if (!empty($no_of_days_req)) {
            $no_of_days = $no_of_days_req;
            $no_of_hours = '';
            $no_of_month = '';
            $paid_amount = (count($pricing_array) > 0) ? $pricing_array->daily_price : '0';
            $booking_type = "Days";
            $total_time = $no_of_days . ' Days';
        } else if (!empty($no_of_month_req)) {
            $no_of_month = $no_of_month_req;
            $no_of_hours = '';
            $no_of_days = '';
            $paid_amount = (count($pricing_array) > 0) ? $pricing_array->monthly_price : '0';
            $booking_type = "Months";
            $total_time = $no_of_month . ' Months';
        }

        $Apikey = $request->Apikey;
        if ($Apikey == APIKEY) {
            $cancellation_fee = (count($GeneralSettings) > 0) ? $GeneralSettings->cancellation_fee : '0';
            $GetParkingspotDetails = ParkingSpot::where('id', $parking_spot_id)->where('status', 'Active')->where('verification_status', 'Yes')->first();
            if (count($GetParkingspotDetails) > 0) {
                $startdatetime = $selected_date . ' ' . $selected_time;
                $booking_id = DB::table('booking')->insertGetId([
                    'users_id' => $userID,
                    'parking_spot_id' => $parking_spot_id,
                    'entry_date_time' => $startdatetime,
                    'exit_date_time' => '0000-00-00 00:00:00',
                    'total_time' => $total_time,
                    'booking_status' => 'Upcoming',
                    'booking_amount' => $paid_amount,
                    'booking_date' => $selected_date,
                    'booking_time' => $selected_time,
                    'booking_type' => $booking_type,
                    'generated_booking_id' => substr(str_shuffle("ABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890"), -9),
                    'booking_hours' => $no_of_hours,
                    'booking_days' => $no_of_days,
                    'booking_month' => $no_of_month,
                    'cancellation_fee' => $cancellation_fee,
                    'additional_credited_amount' => '',
                    'paid_amount' => $paid_amount,
                    'status' => 'Active',
                    'created_date' => Helper::get_curr_datetime(),
                    'created_by' => $userID
                ]);

                $booking_data = DB::table('booking')->Where('id', $booking_id)->first();

                if ($booking_id) {
                    $msg = 'Booking save SuccessFully.';
                    $code = 200;
                    return response()->json(['message' => $msg, 'code' => $code, 'data' => $booking_data], 200, [], JSON_NUMERIC_CHECK);
                } else {
                    $msg = 'Booking does not save SuccessFully.';
                    $code = 101;
                    return response()->json(['message' => $msg, 'code' => $code]);
                }
            } else {
                $msg = 'Parking spot does not available.';
                $code = 101;
                return response()->json(['message' => $msg, 'code' => $code]);
            }
        } else {
            return response()->json(['message' => 'Unauthorised Call', 'code' => 101]);
        }
    }



    /*
     * Request Parameter :  [Apikey, userID, filter_type('all, upcoming, past'), timezone, page_limit, page_offset]
     * Method : POST
     * Request Api Url : "/api/bookingList"
     * Request Controller & Method : BookingController/bookingList
     * Success response : [ message : Success,  code : 200, data : Array of Booking List]
     * Error response : 
      1)[ message : Booking not available., code : 101]
      2)[ message : Unauthorised Call. , code : 101]
     */

    public function bookingList(Request $request) {
        $Apikey = $request->Apikey;
        if ($Apikey == APIKEY) {
            $userID = $request->userID;
            $filter_type = $request->filter_type;
            $timezone = $request->timezone;
            $page_limit = $request->page_limit;
            $page_offset = $request->page_offset;

            date_default_timezone_set($timezone);
            $CurrentDateTime = date('Y-m-d H:i:s');

            if ($page_offset) {
                $page_offset1 = $page_offset + 1;
                $start = ($page_offset1 - 1) * $page_limit;
            } else {
                $start = 0;
            }

            $AndWhere = "";
            if ($filter_type == 'upcoming') {
                $AndWhere .= ' And booking_date >= STR_TO_DATE( "' . $CurrentDateTime . '", "%Y-%m-%d" ) And b.booking_status="Upcoming"';
            } else if ($filter_type == 'past') {
                $AndWhere .= ' And booking_date <= STR_TO_DATE( "' . $CurrentDateTime . '", "%Y-%m-%d" ) And b.booking_status="Cancelled" OR b.booking_status="Completed"';
            }

            $BookingArray = array();
            $BookingSql = "Select b.*, p.id as pid, p.address, p.postal_code, p.country_id, p.state_id, p.city_name, c.country_name, s.state_name "
                    . "from booking as b "
                    . "Left Join parking_spot as p ON b.parking_spot_id = p.id "
                    . "Left Join country as c ON p.country_id = c.id "
                    . "Left Join state as s ON p.state_id = s.id "
                    . "Where b.status='Active'  And b.users_id = '" . $userID . "' 
                    $AndWhere ORDER BY id desc limit " . $start . " , " . $page_limit;
            //. "Where b.status='Active' And b.booking_status='Completed' And b.users_id = '" . $userID . "' $AndWhere ORDER BY id desc limit " . $start . " , " . $page_limit;
            $BookingArray = DB::Select($BookingSql);
            if (count($BookingArray) > 0) {
                foreach ($BookingArray as $single){
                    $single->country_name = ($single->country_name != "" && $single->country_name != null && $single->country_name != 'null') ? $single->country_name : "";
                    $single->state_name = ($single->state_name != "" && $single->state_name != null && $single->state_name != 'null') ? $single->state_name : "";
                    $single->country_id = ($single->country_id != "" && $single->country_id != null && $single->country_id != 'null') ? $single->country_id : 0;
                    $single->state_id = ($single->state_id != "" && $single->state_id != null && $single->state_id != 'null') ? $single->state_id : 0;
                    $single->address = ($single->address != "" && $single->address != null && $single->address != 'null') ? $single->address : "";
                    $single->booking_end_datetime = "";

                    $time = strtotime($single->booking_time);
                    $time_after = $time + (15 * 60);
                    $time_befor = $time - (15 * 60);
                    $single->time_after_15_minutes = date("H:i:s", $time_after);
                    $single->time_befor_15_minutes = date("H:i:s", $time_befor);
                    /*$single->booking_hours_end = "";*/
                    $CurrentDateTime = date('Y-m-d H:i:s');

                    if($single->booking_type == "Months"){
                        $time = strtotime($single->booking_date.' '.$single->booking_time);
                        $temp_month = "+".$single->booking_month." month";
                        $final_end_date = date("Y-m-d H:i:s", strtotime($temp_month, $time));
                        $single->booking_end_datetime = $final_end_date;
                        if( strtotime($CurrentDateTime) > strtotime($final_end_date) ){
                            if(strtotime($single->entry_date_time) == "" && strtotime($single->exit_date_time) == ""){
                                $update = DB::table('booking')
                                    ->where('id', $single->id)
                                    ->update([
                                        'booking_status' => 'Cancelled',
                                        'cancelled_by' => 'User',
                                        'created_date' => Helper::get_curr_datetime(),
                                        'created_by' => $userID
                                    ]);
                                $single->booking_status = "Cancelled";
                                $single->cancelled_by = "User";
                            }
                        }
                    }elseif ($single->booking_type == "days"){
                        $time = strtotime($single->booking_date.' '.$single->booking_time);
                        $temp_day = "+".$single->booking_days." day";
                        $final_end_date = date("Y-m-d H:i:s", strtotime($temp_day, $time));
                        $single->booking_end_datetime = $final_end_date;
                        //echo $final_end_date; exit;
                        if( strtotime($CurrentDateTime) > strtotime($final_end_date) ){
                            if(strtotime($single->entry_date_time) == "" && strtotime($single->exit_date_time) == ""){
                                $update = DB::table('booking')
                                    ->where('id', $single->id)
                                    ->update([
                                        'booking_status' => 'Cancelled',
                                        'cancelled_by' => 'User',
                                        'created_date' => Helper::get_curr_datetime(),
                                        'created_by' => $userID
                                    ]);
                                $single->booking_status = "Cancelled";
                                $single->cancelled_by = "User";
                            }
                        }
                    }elseif ($single->booking_type == "Hours"){
                        $CurrentDate = date('Y-m-d');
                        $current_time = date("H:i:s", time());
                        $time2 = date("H:i:s", strtotime($single->booking_time));
                        $temp_hours = '+' . $single->booking_hours . ' hour';
                        $time2 = date('H:i:s', strtotime($time2 . $temp_hours));
                        $single->booking_end_datetime = $single->booking_date.' '.$time2;
                        if( strtotime($CurrentDate) >= strtotime($single->booking_date) ){
                            if(strtotime($CurrentDate) == strtotime($single->booking_date) && $current_time < $time2){

                            }else{
                                if(strtotime($single->entry_date_time) == "" && strtotime($single->exit_date_time) == ""){
                                    $update = DB::table('booking')
                                        ->where('id', $single->id)
                                        ->update([
                                            'booking_status' => 'Cancelled',
                                            'cancelled_by' => 'User',
                                            'created_date' => Helper::get_curr_datetime(),
                                            'created_by' => $userID
                                        ]);
                                    $single->booking_status = "Cancelled";
                                    $single->cancelled_by = "User";
                                }
                            }
                        }
                    }
                }
                return response()->json(['message' => 'Success', 'code' => 200, 'MybookingList' => $BookingArray], 200, [], JSON_NUMERIC_CHECK);
            } else {
                return response()->json(['message' => 'Booking not available.', 'code' => 101]);
            }
        } else {
            return response()->json(['message' => 'Unauthorised Call', 'code' => 101]);
        }
    }

    /*
     * Request Parameter :  [Apikey, booking_id, userID]
     * Method : POST
     * Request Api Url : "/api/fetchbookingdetails"
     * Request Controller & Method : BookingController/bookingDetails
     * Success response : [ message : Success,  code : 200, data : Array of Booking List]
     * Error response : 
      1)[ message : Booking not available., code : 101]
      2)[ message : Unauthorised Call. , code : 101]
     */

    public function bookingDetails(Request $request) {
        
        $Apikey = $request->Apikey;
        if ($Apikey == APIKEY) {
            $surcharge_amount = DB::table('surcharge_amount')->first();
           
            $booking_id = $request->booking_id;
            $userID = $request->userID;

            $BookingArray = array();
            $BookingSql = "Select b.*,u.id as uid, u.firstname, u.lastname , u.contact_number, u.profile_image, p.latitude, p.longitude,  p.id as pid, p.address, p.postal_code, p.country_id, p.state_id, p.city_name, c.country_name, s.state_name "
                    . "from booking as b "
                    . "Left Join parking_spot as p ON b.parking_spot_id = p.id "
                    . "Left Join users as u ON p.users_id = u.id "
                    . "Left Join country as c ON p.country_id = c.id "
                    . "Left Join state as s ON p.state_id = s.id "
                    . "Where b.status='Active' And b.id = '" . $booking_id . "'";
            //. "Where b.status='Active' And b.booking_status='Completed' And b.id = '" . $booking_id . "'";
            $BookingArray = DB::Select($BookingSql);
            
            if (count($BookingArray) > 0) {
                
                $date_diff = Helper::timeAgo(strtotime($BookingArray[0]->entry_date_time),strtotime($BookingArray[0]->exit_date_time));
                $surcharge = "";
                if(isset($date_diff) && !empty($date_diff)){
                    if($date_diff[1] == "minutes" && $date_diff[0] < 30){
                        $surcharge = $surcharge_amount->amount_before_half_min;
                    }elseif ($date_diff[1] == "minutes" && $date_diff[0] > 30) {
                        $surcharge = $surcharge_amount->amount_after_half_min;
                    }elseif ($date_diff[1] == "hours") {
                        $surcharge = $date_diff[0] * $surcharge_amount->amount_after_half_min;
                    }
                }
                $BookingArray[0]->surcharge_amount = $surcharge;
                
                
                foreach ($BookingArray as $booking) {
                    $booking->profile_image = !empty($booking->profile_image) ? asset('uploads/user_profile_image/' . $booking->profile_image) : "";
                    $booking->country_name = ($booking->country_name != "" && $booking->country_name != null && $booking->country_name != 'null') ? $booking->country_name : "";
                    $booking->state_name = ($booking->state_name != "" && $booking->state_name != null && $booking->state_name != 'null') ? $booking->state_name : "";
                    $booking->country_id = ($booking->country_id != "" && $booking->country_id != null && $booking->country_id != 'null') ? $booking->country_id : 0;
                    $booking->state_id = ($booking->state_id != "" && $booking->state_id != null && $booking->state_id != 'null') ? $booking->state_id : 0;
                    $booking->latitude = ($booking->latitude != "" && $booking->latitude != null && $booking->latitude != 'null') ? $booking->latitude : 0;
                    $booking->longitude = ($booking->longitude != "" && $booking->longitude != null && $booking->longitude != 'null') ? $booking->longitude : 0;
                 
                }

                $ExistReview = DB::table('review')
                                ->where('booking_id', $booking_id)
                                ->Where('users_id', $userID)
                                ->first();
                if (count($ExistReview) > 0) {
                    //$ExistReview->questions_answer = (!empty($ExistReview->questions_answer) ? unserialize($ExistReview->questions_answer) : array());
                    //$ExistReview->questions_answer = (!empty($ExistReview->questions_answer) ? json_decode($ExistReview->questions_answer) : array());
                    /*if(!empty($ExistReview->questions_answer)){
                            $tempQA = json_decode($ExistReview->questions_answer);
                            $temparray = [];
                            foreach($tempQA as $val){
                               foreach ($val as $key1=>$val1){
                                   array_push($temparray, array('answer' =>$val1));
                               }
                            }
                             //print_r($temparray);exit;
                            $ExistReview->questions_answer = $temparray;
                    }  else {
                        $ExistReview->questions_answer = array();
                    }*/
                }else{
                    $ExistReview = array();
                }
                $SubmitedReview =array();
                $sql="
                    SELECT 
                         p.users_id
                    FROM parking_spot as p
                    LEFT JOIN booking ON booking.parking_spot_id = p.id       
                    WHERE booking.id = '$booking_id'
                    AND booking.users_id = '$userID'     
                    ";
                 $results = DB::select( DB::raw($sql) );
                 if(isset($results) && !empty($results[0]->users_id)){
                    $SubmitedReview = DB::table('review')->where('booking_id', $booking_id)->Where('users_id', $results[0]->users_id)->first();
                     if (count($SubmitedReview) > 0) {
                         
                     }  else {
                         $SubmitedReview = array();
                     }
                }
                

                return response()->json(['message' => 'Success', 'code' => 200, 'BookingDetails' => $BookingArray, 'ReceivedReview' => $SubmitedReview, 'SubmitedReview' =>  $ExistReview], 200, [], JSON_NUMERIC_CHECK);
            } else {
                return response()->json(['message' => 'Booking not available.', 'code' => 101]);
            }
        } else {
            return response()->json(['message' => 'Unauthorised Call', 'code' => 101]);
        }
    }

    /*
     * Request Parameter :  [Apikey, booking_id]
     * Method : POST
     * Request Api Url : "/api/deletebooking"
     * Request Controller & Method : BookingController/deletebooking
     * Success response : [ message : Booking deleted successfully.,  code : 200]
     * Error response : 
      1)[ message : Booking not deleted successfully., code : 101]
      2)[ message : Unauthorised Call. , code : 101]
     */

    public function deletebooking(Request $request) {
        $Apikey = $request->Apikey;
        if ($Apikey == APIKEY) {
            $booking_id = $request->booking_id;
            $del_parking_spot = DB::delete('DELETE FROM `booking` WHERE id IN (' . $booking_id . ')');
            if ($del_parking_spot) {
                $msg = 'Booking deleted successfully.';
                $code = 200;
                return response()->json(['message' => $msg, 'code' => $code]);
            } else {
                $msg = 'Booking not deleted successfully.';
                $code = 101;
                return response()->json(['message' => $msg, 'code' => $code]);
            }
        } else {
            return response()->json(['message' => 'Unauthorised Call', 'code' => 101]);
        }
    }

    /*
     * Request Parameter :  [Apikey, booking_id]
     * Method : POST
     * Request Api Url : "/api/canclebookingbyuser"
     * Request Controller & Method : BookingController/canclebookingbyuser
     * Success response : [ message : Booking cancel by user successfully.,  code : 200]
     * Error response : 
      1)[ message : Booking cancel by user not successfully., code : 101]
      2)[ message : Unauthorised Call. , code : 101]
     */

    public function canclebookingbyuser(Request $request) {
        $Apikey = $request->Apikey;
        if ($Apikey == APIKEY) {
            $booking_id = $request->booking_id;

            $booking_update_id = DB::table('booking')->where('id', $booking_id)->update([
                'cancelled_by' => 'User'
            ]);
            if ($booking_update_id) {
                $msg = 'Booking cancel by user successfully.';
                $code = 200;
                return response()->json(['message' => $msg, 'code' => $code]);
            } else {
                $msg = 'Booking cancel by user not successfully.';
                $code = 101;
                return response()->json(['message' => $msg, 'code' => $code]);
            }
        } else {
            return response()->json(['message' => 'Unauthorised Call', 'code' => 101]);
        }
    }
    
    /*
     * Request Parameter :  [Apikey, booking_id,parking_spot_id]
     * Method : POST
     * Request Api Url : "/api/canclebooking"
     * Request Controller & Method : BookingController/canclebookingbyuser
     * Success response : [ message : Booking cancel by user successfully.,  code : 200]
     * Error response : 
      1)[ message : Booking cancel by user not successfully., code : 101]
      2)[ message : Unauthorised Call. , code : 101]
     */
    
    public function canclebooking(Request $request) {
        $Apikey = $request->Apikey;
        if ($Apikey == APIKEY) {
            $booking_id = $request->booking_id;
            $parking_spot_id = $request->parking_spot_id;
            
            $BookingSql = "Select b.users_id as b_user_id, p.users_id as p_user_id "
                    . "from booking as b "
                    . "Left Join parking_spot as p ON b.parking_spot_id = p.id "
                    . "Where b.status='Active' And b.id = '" . $booking_id . "' And b.parking_spot_id = '" . $parking_spot_id . "'";
            //. "Where b.status='Active' And b.booking_status='Completed' And b.id = '" . $booking_id . "'";
            $BookingArray = DB::Select($BookingSql);
            
            if(isset($BookingArray) && !empty($BookingArray)){
                $cancelled_by = '';
                if($BookingArray[0]->b_user_id == $BookingArray[0]->p_user_id){
                    $cancelled_by = "Host";
                }  else {
                    $cancelled_by = "User";
                }
                

            $booking_update_id = DB::table('booking')->where('id', $booking_id)->update([
                'cancelled_by' => $cancelled_by,
                'booking_status' => "Cancelled"
            ]);
            
            if ($booking_update_id) {
                $msg = 'Booking cancel by '.$cancelled_by.' successfully.';
                $code = 200;
                return response()->json(['message' => $msg, 'code' => $code]);
            } else {
                $msg = 'Booking cancel by '.$cancelled_by.' not successfully.';
                $code = 101;
                return response()->json(['message' => $msg, 'code' => $code]);
            }
            }
            
        } else {
            return response()->json(['message' => 'Unauthorised Call', 'code' => 101]);
        }
    }

    /*
     * Request Parameter :  [Apikey, booking_id, entry_date_time]
     * Method : POST
     * Request Api Url : "/api/entryinbooking"
     * Request Controller & Method : BookingController/entryinbooking
     * Success response : [ message : Entry by user successfully.,  code : 200]
     * Error response :
      1)[ message : Entry by user not successfully., code : 101]
      2)[ message : Unauthorised Call. , code : 101]
     */
    public function entryinbooking(Request $request){
        $Apikey = $request->Apikey;
        date_default_timezone_set($request->timezone);
        if ($Apikey == APIKEY && isset($request->booking_id)) {
            $booking_entry = DB::table('booking')->where('id', $request->booking_id)->update([
                'entry_date_time' => $request->entry_date_time
            ]);
            if ($booking_entry) {
                $msg = 'Entry by user successfully.';
                $code = 200;
                return response()->json(['message' => $msg, 'code' => $code]);
            } else {
                $msg = 'Entry by user not successfully.';
                $code = 101;
                return response()->json(['message' => $msg, 'code' => $code]);
            }
        }else{
            return response()->json(['message' => 'Unauthorised Call', 'code' => 101]);
        }
    }

    /*
     * Request Parameter :  [Apikey, booking_id,exit_date_time, timezone]
     * Method : POST
     * Request Api Url : "/api/exitfrombooking"
     * Request Controller & Method : BookingController/exitfrombooking
     * Success response : [ message : Exit by user successfully.,  code : 200]
     * Error response :
      1)[ message : Exit by user not successfully., code : 101]
      2)[ message : Unauthorised Call. , code : 101]
     */

    public function exitfrombooking(Request $request){
        $Apikey = $request->Apikey;
        if ($Apikey == APIKEY && isset($request->booking_id)) {
            date_default_timezone_set($request->timezone);
            $booking_exit = DB::table('booking')->where('id', $request->booking_id)->update([
                'exit_date_time' => $request->exit_date_time,
                'booking_status' => 'Completed'
            ]);
            if ($booking_exit) {
                $surcharge_amount = DB::table('surcharge_amount')->first();
                $booking = DB::table('booking')->where('id',$request->booking_id)->first();

                $date_diff = Helper::timeAgo(strtotime($booking->exit_date_time),strtotime(date('Y-m-d H:i:s',$request->exit_date_time)));

                $surcharge = 0;
                if(strtotime($booking->exit_date_time) < strtotime(date('Y-m-d H:i:s',$request->exit_date_time))){
                    if(isset($date_diff) && !empty($date_diff)){
                        if($date_diff[1] == "minutes" && $date_diff[0] < 30){
                            $surcharge = $surcharge_amount->amount_before_half_min;
                        }elseif ($date_diff[1] == "minutes" && $date_diff[0] > 30) {
                            $surcharge = $surcharge_amount->amount_after_half_min;
                        }elseif ($date_diff[1] == "hours") {
                            $surcharge =  $date_diff[0] * $surcharge_amount->amount_per_hour;
                        }
                    }
                }
                $booking->surcharge = $surcharge;
                $msg = 'Exit by user successfully.';
                $code = 200;
                return response()->json(['message' => $msg, 'code' => $code, 'booking_details' => $booking], 200, [], JSON_NUMERIC_CHECK);
            } else {
                $msg = 'Exit by user not successfully.';
                $code = 101;
                return response()->json(['message' => $msg, 'code' => $code]);
            }
        }else{
            return response()->json(['message' => 'Unauthorised Call', 'code' => 101]);
        }
    }
}
